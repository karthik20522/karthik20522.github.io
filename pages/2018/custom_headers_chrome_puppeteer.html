<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Everyone meet Karthik</title>

    <link rel="stylesheet" href="/stylesheets/styles.css">
    <link rel="stylesheet" href="/stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>
<body>
    <div class="wrapper">
        <header>
            <div style="width:100%; text-align: center;">
                <a href="/"><img src="/images/0.jpg" style="border-radius: 50%;" /></a>
            </div>
            <h1 style="margin-bottom: 1px; text-align: center;">//Karthik Srinivasan</h1>
            <p style="text-align: center;">Product Engineer, CTO & a Beer Enthusiast</p>
            <p class="view" style="margin:0;"><a href="https://github.com/karthik20522?tab=repositories" target="_blank"><img src="/images/github.svg" height="15px" style="margin-right: 5px;" />Quirky Personal Projects</a></p>
            <p class="view" style="margin:0;"><a href="https://linkedin.com/in/karthik-srinivasan-07b23493/" target="_blank"><img src="/images/linkedin-logo.png" height="15px" style="margin-right: 5px;" />LinkedIn</a></p>
            <p class="view" style="margin:0;"><a href="/pages/beers_in_my_belly.html" target="_blank"><img src="/images/beer.png" height="15px" style="margin-right: 5px;" />Beers in my belly</a></p>
            <p class="view"><a href="mailto:karthik20522 (at) yahoo (dot) com" target="_blank"><img src="/images/email.png" height="15px" style="margin-right: 5px;" />Email me</a></p>
        </header>
        <section>
<h1 class="entry-title">Setting custom headers to Puppeteer</h1>
<p>Feb 19, 2018</p>
<pre class="language-javascript"><code>const chrome = require("chrome-aws-lambda");
const fetch = require("node-fetch");
const isProd = process.env.NODE_ENV === "production";
var puppeteer;

if (!isProd) puppeteer = require("puppeteer-core");
else puppeteer = require("puppeteer");

global.Headers = fetch.Headers;

module.exports = async function (req, res) {

    let url = req.body.url;    
    let waitForDom = req.body.dom;
    let waitTimeout = req.body.timeout || 3000;

	let browser;
	try {
		browser = await puppeteer.launch({
			args: chrome.args,
			executablePath: await chrome.executablePath,
			headless: true
		});

		const page = await browser.newPage();
		await page.setRequestInterception(true);

		page.on("request", req =&gt; {
			/**** ************** ****/
			/**** CUSTOM HEADERS ****/
			/**** ************** ****/
			const headers = req.headers();

			headers["Accept"] = "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8";
			headers["Content-Type"] = "application/x-www-form-urlencoded";
			headers["User-Agent"] = "Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.11 (KHTML, like Gecko) Chrome/23.0.1271.97 Safari/537.11";
			headers["Accept-Encoding"] = "gzip,deflate,sdch";
			headers["Accept-Language"] = "en-GB,en-US;q=0.8,en;q=0.6";
			headers["Accept-Charset"] = "ISO-8859-1,utf-8;q=0.7,*;q=0.3";

			if (req.resourceType() == "stylesheet" || req.resourceType() == "font" || req.resourceType() == "image") req.abort();
			else req.continue({ headers });
		});

		await page.goto(url);

		try {
			await page.waitForSelector(waitForDom, { timeout: waitTimeout });
			const content = await page.content();
			res.setHeader('content-type', 'text/html');
			res.send(content);
		} catch (e) {
			return undefined;
		}
	} catch (e) {
		res.statusCode = 500;
		res.setHeader("Content-Type", "text/html");
		res.end("&lt;h1&gt;Server Error&lt;/h1&gt;&lt;p&gt;Sorry, there was a problem&lt;/p&gt;" + e);
	} finally {
		if (browser) browser.close();
	}   
};</code></pre><!--*********************FOOTER'ISH************************-->
<div id="graphcomment"></div>
<script type="text/javascript">
    /*window.gc_params = {
        graphcomment_id: 'Karthik-Github',
        fixed_header_height: 0,
    };
    (function () {
        var gc = document.createElement('script'); gc.type = 'text/javascript'; gc.async = true;
        gc.src = 'https://graphcomment.com/js/integration.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(gc);
    })();*/
</script>

</section>
<footer></footer>
</div>
<script src="/javascripts/scale.fix.js"></script>
<script>
/*    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'UA-140795658-1');*/
</script>
</body>
</html>
